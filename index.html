<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Page Range Extractor + Preview</title>
  <!-- UI fonts/colors and layout -->
  <style>
    :root { --bg:#0b1020; --card:#131a2a; --muted:#96a0b5; --accent:#7c9cff; --ok:#3bd671; --err:#ff6b6b; --selStart:#2ecc71; --selEnd:#4aa3ff; }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;background:var(--bg);color:#e8eefc}
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .p-24{padding:24px}
    .input{background:#0e1525;border:1px solid #23324d;color:#e8eefc;border-radius:12px;padding:12px 14px}
    .btn{background:linear-gradient(180deg,#5d7cff,#6d89ff);border:0;color:white;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:6px}
    .hint{font-size:.9rem;color:var(--muted)}
    .badge{display:inline-block;border:1px solid #2c3e66;border-radius:999px;padding:4px 10px;font-size:.85rem;color:#cfe0ff}
    .err{color:var(--err)}
    .ok{color:var(--ok)}
    .divider{height:1px;background:#1f2740;margin:18px 0}
    .footer{font-size:.85rem;color:var(--muted);text-align:center;margin-top:22px}
    .dropzone{border:2px dashed #2c3e66;border-radius:14px;padding:24px;text-align:center;transition:.2s}
    .dropzone.drag{background:#0f1830}
    .iconbtn{display:inline-flex;align-items:center;gap:6px;background:#0e1525;border:1px solid #2c3e66;color:#cfe0ff;border-radius:999px;padding:8px 10px;cursor:pointer}
    .iconbtn:hover{background:#121c33}
    .iconbtn svg{width:14px;height:14px}

    /* Preview grid */
    .previewWrap{margin-top:20px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .grid{display:grid;gap:12px}
    /* Add per-row classes 1..4 (5 already exists) */
    .cols1{grid-template-columns:repeat(1,1fr)}
    .cols2{grid-template-columns:repeat(2,1fr)}
    .cols3{grid-template-columns:repeat(3,1fr)}
    .cols4{grid-template-columns:repeat(4,1fr)}
    .cols5{grid-template-columns:repeat(5,1fr)}
    .thumb{position:relative;background:#0d1425;border:1px solid #23324d;border-radius:10px;overflow:hidden;cursor:pointer;transition:.12s}
    .thumb:hover{box-shadow:0 0 0 2px #2c3e66 inset}
    .thumb canvas{width:100%;height:auto;display:block;background:#0b1020}
    .pgnum{position:absolute;top:6px;left:6px;background:rgba(0,0,0,.55);padding:2px 6px;border-radius:999px;font-size:12px}
    .isStart{outline:3px solid var(--selStart)}
    .isEnd{outline:3px solid var(--selEnd)}

    /* Context menu for choosing start/end */
    .ctx{position:absolute;z-index:20;background:#0e1525;border:1px solid #2c3e66;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.5);padding:6px;display:none}
    .ctx button{display:block;width:100%;background:transparent;color:#e8eefc;border:0;text-align:left;padding:8px 10px;border-radius:8px;cursor:pointer}
    .ctx button:hover{background:#121c33}
    .stickyMsg{position:sticky;top:0;background:rgba(19,26,42,.9);backdrop-filter:blur(6px);padding:8px 12px;border:1px solid #2c3e66;border-radius:10px}
    .previewScroller{max-height:60vh;overflow:auto;padding:12px;border:1px dashed #2c3e66;border-radius:14px}
  </style>
  <!-- pdf-lib provides in-browser PDF manipulation (no server needed) -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <!-- pdf.js for rendering page previews (thumbnails) -->
  <!-- Downgrade to a UMD-compatible version (v3.x) so window.pdfjsLib and workerSrc work -->
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    // Configure pdf.js worker (match version above)
    if(window['pdfjsLib']){
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    }
  </script>
</head>
<body>
  <div class="wrap">
    <!-- Top-right language selector -->
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
      <label for="langSel" class="hint" style="margin:0 8px 0 0"><span id="langLabel">Language</span>:</label>
      <select id="langSel" class="input" style="padding:6px 10px;height:auto">
        <option value="en">English</option>
        <option value="zh">中文</option>
      </select>
    </div>

    <h1 style="font-size:1.8rem;margin:0 0 16px">PDF Page Range Extractor</h1>
    <p id="introHint" class="hint" style="margin:0 0 22px">
      Upload a PDF, choose start & end pages (1‑indexed), and download a new PDF with just those pages. All processing happens
      <strong>in your browser</strong>—no uploads to a server.
    </p>

    <div class="card p-24">
      <!-- Accessible drop area + hidden file input -->
      <div id="drop" class="dropzone" tabindex="0" role="button" aria-label="Upload or drop a PDF here">
        <div id="dropText" style="margin-bottom:10px">⬆️ Drop your PDF here or click to browse</div>
        <input id="file" type="file" accept="application/pdf" style="display:none" />
        <div id="dropHint" class="hint">Max size depends on your device memory. Works best for typical PDFs &lt; 200MB.</div>
      </div>

      <div class="divider"></div>

      <!-- Simple form for start/end and optional output filename -->
      <div class="row">
        <div style="flex:1;min-width:160px">
          <label id="labelStart" for="start">Start page</label>
          <input id="start" class="input" type="number" min="1" step="1" placeholder="e.g., 36" />
        </div>
        <div style="flex:1;min-width:160px">
          <label id="labelEnd" for="end">End page</label>
          <input id="end" class="input" type="number" min="1" step="1" placeholder="e.g., 66" />
        </div>
        <div style="flex:3;min-width:220px">
          <label id="labelOutname" for="outname">Output filename</label>
          <!-- Make this input fill its container -->
          <input id="outname" class="input" type="text" placeholder="auto (based on source & range)" style="width:50%" />
        </div>
      </div>

      <!-- File meta badge, remove-file button, and primary action -->
      <div class="row" style="align-items:center;justify-content:space-between;margin-top:16px">
        <div class="row" style="align-items:center;gap:10px">
          <span id="meta" class="badge">No file loaded</span>
          <!-- Hidden by default; shown once a PDF is loaded -->
          <button id="removeBtn" class="iconbtn" style="display:none" title="Remove loaded file" aria-label="Remove loaded file">
            <!-- Trash icon (feather-like) -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </button>
        </div>
        <div class="row" style="align-items:center;gap:10px">
          <!-- Update initial label; JS will keep it in sync -->
          <button id="toggleCols" class="iconbtn" style="display:none" title="Toggle density">Cycle 1–5 per row</button>
          <button id="extract" class="btn" disabled>Extract pages</button>
        </div>
      </div>

      <!-- Status / guidance messages -->
      <div class="stickyMsg hint" id="msg"></div>

      <!-- Preview area -->
      <div class="previewWrap" id="previewWrap" style="display:none">
        <div class="toolbar">
          <div id="toolbarHint" class="hint">Click a page to set <strong>Start</strong>, then <strong>End</strong>. End cannot be set before Start.</div>
          <div class="hint"><span id="layoutPrefix">Layout:</span> <span id="layoutLabel">5 per row</span></div>
        </div>
        <div class="previewScroller">
          <div id="grid" class="grid cols5"></div>
        </div>
        <!-- shared floating context menu (reused for all thumbs) -->
        <div id="ctx" class="ctx" role="menu" aria-hidden="true">
          <button id="ctxStart" type="button">Set as start page</button>
          <button id="ctxEnd" type="button">Set as end page</button>
        </div>
      </div>
    </div>

    <!-- Replace the footer paragraph to add an id for i18n -->
    <p id="footerTips" class="footer">Tips: Pages are <strong>1‑indexed</strong>. Example: to extract pages 36–66, enter start=36 and end=66.
      If end exceeds the document length, it will be clamped to the last page.</p>
  </div>

  <script>
    // ====== Element references ======
    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');
    const startEl = document.getElementById('start');
    const endEl = document.getElementById('end');
    const outnameEl = document.getElementById('outname');
    const extractBtn = document.getElementById('extract');
    const metaEl = document.getElementById('meta');
    const msgEl = document.getElementById('msg');
    const removeBtn = document.getElementById('removeBtn');
    const previewWrap = document.getElementById('previewWrap');
    const grid = document.getElementById('grid');
    const ctx = document.getElementById('ctx');
    const ctxStart = document.getElementById('ctxStart');
    const ctxEnd = document.getElementById('ctxEnd');
    const toggleColsBtn = document.getElementById('toggleCols');
    const layoutLabel = document.getElementById('layoutLabel');
    const footerTipsEl = document.getElementById('footerTips'); // + add ref

    // Language UI refs
    const langSel = document.getElementById('langSel');
    const langLabelEl = document.getElementById('langLabel');
    const introHintEl = document.getElementById('introHint');
    const dropTextEl = document.getElementById('dropText');
    const dropHintEl = document.getElementById('dropHint');
    const labelStartEl = document.getElementById('labelStart');
    const labelEndEl = document.getElementById('labelEnd');
    const labelOutnameEl = document.getElementById('labelOutname');
    const toolbarHintEl = document.getElementById('toolbarHint');
    const layoutPrefixEl = document.getElementById('layoutPrefix');

    // ====== I18N ======
    let lang = localStorage.getItem('lang') || 'en';
    const I18N = {
      en: {
        language: 'Language',
        title: 'PDF Page Range Extractor',
        introHint: 'Upload a PDF, choose start & end pages (1‑indexed), and download a new PDF with just those pages. All processing happens <strong>in your browser</strong>—no uploads to a server.',
        dropText: '⬆️ Drop your PDF here or click to browse',
        dropHint: 'Max size depends on your device memory. Works best for typical PDFs < 200MB.',
        labelStart: 'Start page',
        labelEnd: 'End page',
        labelOutname: 'Output filename',
        extract: 'Extract pages',
        toolbarHint: 'Click a page to set <strong>Start</strong>, then <strong>End</strong>. End cannot be set before Start.',
        layoutPrefix: 'Layout:',
        perRowBtn: '{from} → {to} per row',
        perRowLabel: '{n} per row',
        noFile: 'No file loaded',
        loading: 'Loading PDF…',
        choosePdf: 'Please choose a PDF file.',
        loaded: 'Loaded. Enter start & end pages, or pick from the preview below.',
        previewNA: 'Preview not available (pdf.js failed to load). You can still extract pages.',
        failedLoad: 'Failed to load PDF. If the file is encrypted or corrupted, try unlocking/repairing it first.',
        removed: 'File removed.',
        needLoad: 'Load a PDF first.',
        needBoth: 'Please enter both start and end pages (numbers).',
        startLeEnd: 'Start page must be ≤ end page.',
        extracting: 'Extracting pages {a}–{b}…',
        done: 'Done! Downloaded “{name}”.',
        oops: 'Something went wrong while extracting pages.',
        startSet: 'Start page set to {n}. Now choose an end page.',
        needStart: 'Choose a start page first.',
        endBefore: 'End page cannot be before start page.',
        endSet: 'End page set to {n}.',
        startPh: 'e.g., 36',
        endPh: 'e.g., 66',
        outnamePh: 'auto (based on source & range)',
        footerTips: 'Tips: Pages are <strong>1‑indexed</strong>. Example: to extract pages 36–66, enter start=36 and end=66. If end exceeds the document length, it will be clamped to the last page.',
        ctxStartLabel: 'Set as start page',
        ctxEndLabel: 'Set as end page'
      },
      zh: {
        language: '语言',
        title: 'PDF 页面范围提取器',
        introHint: '上传 PDF，选择起始页和结束页（从 1 开始），下载只包含这些页面的新 PDF。所有处理都在<strong>浏览器本地</strong>完成——不会上传到服务器。',
        dropText: '⬆️ 将 PDF 拖拽到此处或点击选择文件',
        dropHint: '可处理的大小取决于设备内存。推荐处理小于 200MB 的 PDF。',
        labelStart: '起始页',
        labelEnd: '结束页',
        labelOutname: '输出文件名',
        extract: '提取页面',
        toolbarHint: '点击某页设置<strong>起始页</strong>，再点击设置<strong>结束页</strong>。结束页不能早于起始页。',
        layoutPrefix: '布局：',
        perRowBtn: '每行 {from} → {to} 页',
        perRowLabel: '每行 {n} 页',
        noFile: '未加载文件',
        loading: '正在加载 PDF…',
        choosePdf: '请选择 PDF 文件。',
        loaded: '已加载。请输入起始/结束页，或在下方预览中选择。',
        previewNA: '无法预览（pdf.js 加载失败）。仍可直接提取页面。',
        failedLoad: '加载 PDF 失败。如文件已加密或损坏，请先解锁/修复后再试。',
        removed: '已移除文件。',
        needLoad: '请先加载 PDF。',
        needBoth: '请同时输入起始页和结束页（数字）。',
        startLeEnd: '起始页必须小于或等于结束页。',
        extracting: '正在提取第 {a}–{b} 页…',
        done: '完成！已下载 “{name}”。',
        oops: '提取过程中出现问题。',
        startSet: '已设置起始页为 {n}。现在请选择结束页。',
        needStart: '请先选择起始页。',
        endBefore: '结束页不能早于起始页。',
        endSet: '已设置结束页为 {n}。',
        startPh: '例如：36',
        endPh: '例如：66',
        outnamePh: '自动（基于源文件与范围）',
        footerTips: '提示：页码从 <strong>1</strong> 开始计数。示例：要提取第 36–66 页，请输入 起始页=36、结束页=66。若结束页超过文档页数，将自动截断到最后一页。',
        ctxStartLabel: '设为起始页',
        ctxEndLabel: '设为结束页'
      }
    };

    function t(key, vars){
      let s = (I18N[lang] && I18N[lang][key]) || (I18N.en[key] || '');
      if(vars){
        for(const k in vars){
          s = s.replace(new RegExp('\\{'+k+'\\}','g'), String(vars[k]));
        }
      }
      return s;
    }

    function applyLanguage(){
      document.title = t('title');
      document.querySelector('h1').textContent = t('title');
      langLabelEl.textContent = t('language');
      introHintEl.innerHTML = t('introHint');
      dropTextEl.textContent = t('dropText');
      dropHintEl.textContent = t('dropHint');
      labelStartEl.textContent = t('labelStart');
      labelEndEl.textContent = t('labelEnd');
      labelOutnameEl.textContent = t('labelOutname');
      extractBtn.textContent = t('extract');
      toolbarHintEl.innerHTML = t('toolbarHint');
      layoutPrefixEl.textContent = t('layoutPrefix');
      // Placeholders
      startEl.placeholder = t('startPh');
      endEl.placeholder = t('endPh');
      outnameEl.placeholder = t('outnamePh');
      // Meta “no file” if nothing loaded
      if(!srcDoc) metaEl.textContent = t('noFile');
      // Update footer tips
      footerTipsEl.innerHTML = t('footerTips');
      // Update context menu button labels
      ctxStart.textContent = t('ctxStartLabel');
      ctxEnd.textContent = t('ctxEndLabel');
    }

    // ====== In-memory state for the currently loaded PDF ======
    let srcBytes = null; let srcDoc = null; let srcName = null; let pageCount = 0; let pdfjsDoc = null;

    // Selection state
    let selectedStart = null; let selectedEnd = null;

    // Track which page the context menu is acting on
    let ctxPage = null;

    // Layout state: 1..5 columns per row
    let perRow = 5;

    // Utility: set status/help message with optional color class.
    function setMsg(text, type='info'){
      msgEl.textContent = text || '';
      msgEl.classList.remove('err','ok');
      if(type==='err') msgEl.classList.add('err');
      if(type==='ok') msgEl.classList.add('ok');
    }

    // Clear start/end highlights on all thumbs.
    function clearHighlights(){
      grid.querySelectorAll('.thumb').forEach(el=> el.classList.remove('isStart','isEnd'));
    }

    // Apply highlight classes based on selectedStart/selectedEnd.
    function applyHighlights(){
      clearHighlights();
      if(selectedStart){
        const s = grid.querySelector(`[data-page="${selectedStart}"]`);
        if(s) s.classList.add('isStart');
      }
      if(selectedEnd){
        const e = grid.querySelector(`[data-page="${selectedEnd}"]`);
        if(e) e.classList.add('isEnd');
      }
    }

    // Reset all state and UI back to "no file loaded".
    function clearState(){
      srcBytes = null; srcDoc = null; srcName = null; pageCount = 0; pdfjsDoc = null;
      selectedStart = null; selectedEnd = null;
      if(fileInput) fileInput.value = '';
      metaEl.textContent = t('noFile');
      removeBtn.style.display = 'none';
      extractBtn.disabled = true;
      previewWrap.style.display = 'none';
      grid.innerHTML = '';
      setMsg('');
      // Reset layout UI to default (5 per row) for next load
      perRow = 5;
    }

    // Apply perRow to grid classes and labels
    function applyPerRow(){
      for(let i=1;i<=5;i++) grid.classList.remove('cols'+i);
      grid.classList.add('cols'+perRow);
      toggleColsBtn.textContent = t('perRowBtn', { from: perRow, to: (perRow % 5) + 1 });
      layoutLabel.textContent = t('perRowLabel', { n: perRow });
    }

    // Render the preview grid using pdf.js. We render small canvases (thumbnails) for performance.
    async function renderPreviews(){
      if(!pdfjsDoc) return;
      grid.innerHTML = '';
      // Determine a reasonable thumbnail width based on column count.
      const colCount = perRow;
      const containerWidth = grid.clientWidth || 1000;
      const thumbWidth = Math.max(80, Math.floor((containerWidth - (colCount-1)*12) / colCount));

      for(let i=1;i<=pageCount;i++){
        const cell = document.createElement('div');
        cell.className = 'thumb';
        cell.dataset.page = String(i);

        // Small label with page number
        const badge = document.createElement('div');
        badge.className = 'pgnum';
        badge.textContent = i;
        cell.appendChild(badge);

        const canvas = document.createElement('canvas');
        cell.appendChild(canvas);
        grid.appendChild(cell);

        // Click to open context menu near the thumbnail
        cell.addEventListener('click', (ev)=> openCtxMenu(ev, i, cell));

        // Render asynchronously; don't block loop
        renderThumb(i, canvas, thumbWidth).catch(err=> console.warn('thumb render error p'+i, err));
      }
      applyHighlights();
    }

    // Render a single page thumbnail into the given canvas at a target width.
    async function renderThumb(pageNumber, canvas, width){
      const page = await pdfjsDoc.getPage(pageNumber);
      const viewport = page.getViewport({ scale: 1 });
      const scale = width / viewport.width;
      const scaled = page.getViewport({ scale });
      const ctx2d = canvas.getContext('2d', { willReadFrequently: false });
      canvas.width = Math.floor(scaled.width);
      canvas.height = Math.floor(scaled.height);
      await page.render({ canvasContext: ctx2d, viewport: scaled }).promise;
    }

    // Position and show the small context menu near the clicked thumbnail.
    function openCtxMenu(ev, pageNum, cell){
      ev.preventDefault();
      const rect = cell.getBoundingClientRect();
      // Place menu near bottom-right of the cell, but keep inside viewport when possible
      const x = rect.left + Math.min(rect.width - 150, Math.max(8, ev.clientX - rect.left - 60));
      const y = rect.top + Math.min(rect.height - 10, Math.max(8, ev.clientY - rect.top + 6));
      ctx.style.left = `${x + window.scrollX}px`;
      ctx.style.top = `${y + window.scrollY}px`;
      ctx.style.display = 'block';
      ctx.setAttribute('aria-hidden','false');

      // Remember the page for the shared handlers
      ctxPage = pageNum;

      // Enable/disable buttons depending on selection state and pageNum
      ctxStart.disabled = false;
      ctxEnd.disabled = (selectedStart == null) || (pageNum < selectedStart);
    }

    function hideCtx(){
      ctx.style.display = 'none';
      ctx.setAttribute('aria-hidden','true');
      ctxPage = null;
    }

    // One-time context menu actions using ctxPage
    ctxStart.addEventListener('click', ()=>{
      if(ctxPage == null) return;
      selectedStart = ctxPage;
      selectedEnd = null;
      startEl.value = selectedStart;
      endEl.value = '';
      setMsg(t('startSet', { n: selectedStart }));
      applyHighlights();
      hideCtx();
    });

    ctxEnd.addEventListener('click', ()=>{
      if(ctxPage == null) return;
      if(selectedStart == null){ setMsg(t('needStart'), 'err'); return; }
      if(ctxPage < selectedStart){ setMsg(t('endBefore'), 'err'); return; }
      selectedEnd = ctxPage;
      endEl.value = selectedEnd;
      setMsg(t('endSet', { n: selectedEnd }), 'ok');
      applyHighlights();
      hideCtx();
    });

    // Global hide on scroll/resize/click elsewhere
    document.addEventListener('scroll', hideCtx, true);
    window.addEventListener('resize', hideCtx);
    document.addEventListener('click', (e)=>{
      if(!ctx.contains(e.target) && !e.target.closest('.thumb')) hideCtx();
    });

    // Re-render previews when column density toggles or container resizes
    toggleColsBtn.addEventListener('click', ()=>{
      perRow = (perRow % 5) + 1;
      applyPerRow();
      requestAnimationFrame(()=> renderPreviews());
    });

    // Keep highlights in sync if the user types page numbers manually
    function syncFromInputs(){
      const s = parseInt(startEl.value, 10);
      const e = parseInt(endEl.value, 10);
      selectedStart = Number.isFinite(s) ? s : null;
      selectedEnd = Number.isFinite(e) ? e : null;
      applyHighlights();
    }
    startEl.addEventListener('input', syncFromInputs);
    endEl.addEventListener('input', syncFromInputs);

    // ====== File handling ======
    async function handleFile(file){
      if(!file){ clearState(); return; }
      if(file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')){
        clearState();
        setMsg(t('choosePdf'), 'err');
        return;
      }
      try{
        setMsg(t('loading'));
        const ab = await file.arrayBuffer();
        const doc = await PDFLib.PDFDocument.load(ab, { ignoreEncryption: false });
        srcBytes = ab; srcDoc = doc; srcName = file.name.replace(/\.pdf$/i,'');
        pageCount = doc.getPageCount();
        metaEl.textContent = `${file.name} • ${pageCount} pages`;
        removeBtn.style.display = 'inline-flex';
        extractBtn.disabled = false;
        setMsg(t('loaded'), 'ok');

        if(window['pdfjsLib']){
          pdfjsDoc = await pdfjsLib.getDocument({ data: ab }).promise;
          previewWrap.style.display = 'block';
          perRow = 5; // default layout on load
          applyPerRow();
          toggleColsBtn.style.display = 'inline-flex';
          selectedStart = null; selectedEnd = null; startEl.value=''; endEl.value='';
          await renderPreviews();
        } else {
          previewWrap.style.display = 'none';
          setMsg(t('previewNA'), 'err');
        }
      }catch(err){
        console.error(err);
        clearState();
        setMsg(t('failedLoad'), 'err');
      }
    }

    // ====== Dropzone interactions ======
    drop.addEventListener('click', ()=> fileInput.click());
    drop.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); fileInput.click(); }
    });
    ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', (e)=>{
      const file = e.dataTransfer.files?.[0];
      if(file) handleFile(file);
    });
    fileInput.addEventListener('change', ()=> handleFile(fileInput.files?.[0]));

    // Remove currently loaded file: full reset
    removeBtn.addEventListener('click', ()=>{ clearState(); setMsg(t('removed'),'ok'); });

    // ====== Extraction ======
    extractBtn.addEventListener('click', async ()=>{
      if(!srcDoc){ setMsg(t('needLoad'), 'err'); return; }
      let start = parseInt(startEl.value, 10);
      let end = parseInt(endEl.value, 10);
      if(Number.isNaN(start) || Number.isNaN(end)){
        setMsg(t('needBoth'), 'err');
        return;
      }
      if(start < 1) start = 1;
      if(end < 1) end = 1;
      if(end > pageCount) end = pageCount;
      if(start > end){ setMsg(t('startLeEnd'), 'err'); return; }

      try{
        setMsg(t('extracting', { a: start, b: end }));
        const src = await PDFLib.PDFDocument.load(srcBytes);
        const out = await PDFLib.PDFDocument.create();
        const indices = Array.from({length: end - start + 1}, (_,i)=> i + (start-1));
        const copied = await out.copyPages(src, indices);
        copied.forEach(p => out.addPage(p));
        const outBytes = await out.save();
        const blob = new Blob([outBytes], { type: 'application/pdf' });
        const fname = (outnameEl.value?.trim()) || `${srcName}_p${start}-${end}.pdf`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        setMsg(t('done', { name: fname }), 'ok');
      }catch(err){
        console.error(err);
        setMsg(t('oops'), 'err');
      }
    });

    // ====== Language init and handler ======
    langSel.value = lang;
    langSel.addEventListener('change', ()=>{
      lang = langSel.value;
      localStorage.setItem('lang', lang);
      applyLanguage();
      applyPerRow();
    });
    // Initial apply
    applyLanguage();
    applyPerRow();
  </script>
</body>
</html>